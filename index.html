<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>D11 StoryVerse</title>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="logo.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* (Keep all your original CSS ‚Äî shortened here for brevity in this message,
           but in the file below I include the full CSS exactly as in your original file.) */
        * { font-family: 'Space Grotesk', sans-serif; }
        body { background: #050508; overflow-x: hidden; color: #e0e0e0; }
        /* ... (all other styles from your original file) ... */
        /* I'll include the same long style block from your original file in the full file below */
    </style>
</head>
<body class="bg-mesh min-h-screen">

    <!-- (All the original HTML structure ‚Äî header, nav, modals, forms, etc.)
         I preserved your markup and IDs so existing styles and modal logic remain. -->
    <!-- Floating Background Elements -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="floating absolute top-20 left-20 w-32 h-32 bg-purple-900/20 rounded-full blur-xl"></div>
        <div class="floating absolute top-40 right-32 w-24 h-24 bg-indigo-900/20 rounded-full blur-xl" style="animation-delay: -2s;"></div>
        <div class="floating absolute bottom-32 left-1/3 w-40 h-40 bg-purple-900/20 rounded-full blur-xl" style="animation-delay: -4s;"></div>
        <div class="absolute inset-0 bg-radial-at-center from-purple-900/5 via-transparent to-transparent"></div>
    </div>

    <div class="relative z-10 container mx-auto px-4 py-8 max-w-7xl">
        <header class="text-center mb-16 slide-in">
            <div class="relative inline-block">
                <h1 class="text-6xl sm:text-8xl font-bold neon-text mb-6 tracking-tight">D11 StoryVerse</h1>
                <div class="absolute -inset-4 bg-gradient-to-r from-purple-900/20 to-crimson-900/20 rounded-3xl blur-xl"></div>
                <div class="absolute top-0 -right-20 w-48 h-48 bg-purple-700/10 rounded-full blur-3xl"></div>
            </div>
            <p class="text-xl dark-text-secondary max-w-2xl mx-auto leading-relaxed">SRI LANKA NO 1 STORY HUB.</p>
            <div class="flex justify-center mt-8">
                <div class="flex items-center gap-2 glass px-4 py-2 rounded-full">
                    <div class="w-2 h-2 bg-purple-400 rounded-full animate-pulse"></div>
                    <span class="text-sm dark-text">Community Active</span>
                </div>
            </div>
        </header>

        <!-- Edit Profile Modal -->
<div id="edit-profile-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
  <div class="dark-modal rounded-3xl p-8 w-full max-w-md slide-in">
    <div class="text-center mb-8">
      <div class="w-20 h-20 mx-auto bg-gradient-to-br from-green-900 to-purple-900 rounded-2xl flex items-center justify-center text-3xl mb-4">‚úèÔ∏è</div>
      <h3 class="text-2xl font-bold mb-2 dark-text">Edit Profile</h3>
      <p class="dark-text-secondary">Change your display name</p>
    </div>
    <form id="edit-profile-form" class="space-y-6">
      <div>
        <label class="block text-sm font-medium mb-2 dark-text">New Name</label>
        <input type="text" id="edit-name" class="w-full dark-input rounded-xl p-4" required />
      </div>
      <button type="submit" class="w-full btn-gradient py-4 rounded-xl font-bold micro-interaction">Save</button>
      <button type="button" id="cancel-edit" class="w-full glass py-3 rounded-xl font-medium hover:bg-purple-900/30 dark-text">Cancel</button>
    </form>
  </div>
</div>


<!-- Footer -->
<footer class="fixed bottom-0 left-0 w-full glass-strong border-t border-purple-900/40 py-4 text-center z-50">
  <p class="text-sm dark-text-secondary">¬© 2025 SM StoryVerse. All rights reserved.</p>
  <p class="text-xs mt-1 dark-text">Made with ‚ù§Ô∏è in D11 GROUP</p>
</footer>



        <nav class="glass-strong rounded-3xl p-6 mb-12 slide-in">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-6">
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-3">
                        <div id="avatar" class="w-12 h-12 rounded-full dark-avatar flex items-center justify-center font-bold text-lg">?</div>
                        <div>
                            <p class="font-semibold dark-text" id="user-name">Guest User</p>
                            <p class="text-sm dark-text-secondary" id="user-status">Not authenticated</p>
                        </div>
                    </div>
                </div>

                <div class="flex flex-wrap gap-3">
                    <button id="login-btn" class="btn-gradient px-6 py-3 rounded-2xl font-semibold micro-interaction glow-hover">üîê Login</button>
                    <button id="signup-btn" class="glass px-6 py-3 rounded-2xl font-semibold micro-interaction hover:bg-purple-900/30 dark-text">üåô Sign Up</button>
                    <button id="profile-btn" class="glass px-6 py-3 rounded-2xl font-semibold micro-interaction hover:bg-purple-500/20 dark-text hidden">üë§ My Stories</button>
                    <button id="home-btn" class="glass px-6 py-3 rounded-2xl font-semibold micro-interaction hover:bg-indigo-500/20 dark-text hidden">üåå Explore</button>
                    <button id="logout-btn" class="glass px-6 py-3 rounded-2xl font-semibold micro-interaction hover:bg-red-900/30 dark-text hidden">üëã Logout</button>
                    <button id="edit-profile-btn" class="glass px-6 py-3 rounded-2xl font-semibold micro-interaction hover:bg-green-900/30 dark-text hidden">‚úèÔ∏è Edit Profile</button>
                </div>
            </div>
        </nav>

        <div id="story-form-container" class="mb-16 slide-in hidden">
            <div class="glass-strong rounded-3xl p-8 glow">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-16 h-16 rounded-2xl dark-avatar flex items-center justify-center text-2xl">‚úçÔ∏è</div>
                    <div>
                        <h2 class="text-2xl font-bold dark-text">Write Your Story Here</h2>
                        <p class="dark-text-secondary">Sri Lanka No 1 Story Uploading Hub</p>
                    </div>
                </div>
                <form id="story-form">
                    <div class="relative">
                        <textarea id="story-text" rows="8" class="w-full dark-input rounded-2xl p-6 placeholder-gray-500 resize-none" placeholder="Write Your Special Story Here...‚úçÔ∏è"></textarea>
                        <div class="absolute bottom-4 right-4 text-sm dark-text-secondary" id="char-count">0/10000</div>
                    </div>
                    <button type="submit" class="w-full mt-6 btn-gradient py-4 rounded-2xl font-bold text-lg micro-interaction glow-hover">RELEASE STORY</button>
                </form>
            </div>
        </div>

        <div class="slide-in">
            <div class="flex items-center justify-between mb-8">
                <h2 id="stories-title" class="text-4xl font-bold flex items-center gap-3 dark-text">
                    <span class="text-3xl">üìú</span> Latest Stories
                </h2>
                <div class="glass px-4 py-2 rounded-full">
                    <span id="story-count" class="text-sm dark-text">Loading...</span>
                </div>
            </div>
            <div id="stories-container" class="grid gap-8 sm:grid-cols-1 lg:grid-cols-2 xl:grid-cols-3"></div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="dark-modal rounded-3xl p-8 w-full max-w-md slide-in">
            <div class="text-center mb-8">
                <div class="w-20 h-20 mx-auto dark-avatar rounded-2xl flex items-center justify-center text-3xl mb-4">üîê</div>
                <h3 class="text-2xl font-bold mb-2 dark-text">Enter the StoryVerse </h3>
                <p class="dark-text-secondary">Reveal yourself to the StoryVerse</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium mb-2 dark-text">Email</label>
                    <input type="email" id="login-email" class="w-full dark-input rounded-xl p-4" required />
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 dark-text">Password</label>
                    <input type="password" id="login-password" class="w-full dark-input rounded-xl p-4" required />
                </div>
                <button type="submit" class="w-full btn-gradient py-4 rounded-xl font-bold micro-interaction">Log In</button>
                <button type="button" id="cancel-login" class="w-full glass py-3 rounded-xl font-medium hover:bg-purple-900/30 dark-text">Back</button>
            </form>
        </div>
    </div>

    <!-- Signup Modal -->
    <div id="signup-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="dark-modal rounded-3xl p-8 w-full max-w-md slide-in">
            <div class="text-center mb-8">
                <div class="w-20 h-20 mx-auto crimson-gradient rounded-2xl flex items-center justify-center text-3xl mb-4">‚ú®</div>
                <h3 class="text-2xl font-bold mb-2 dark-text">Join the StoryVerse</h3>
                <p class="dark-text-secondary">Become the Story Writter & Speaker</p>
            </div>
            <form id="signup-form-modal" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium mb-2 dark-text">Full Name</label>
                    <input type="text" id="signup-name" class="w-full dark-input rounded-xl p-4" required />
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 dark-text">Email</label>
                    <input type="email" id="signup-email" class="w-full dark-input rounded-xl p-4" required />
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 dark-text">Password</label>
                    <input type="password" id="signup-password" class="w-full dark-input rounded-xl p-4" required />
                </div>
                <button type="submit" class="w-full crimson-gradient py-4 rounded-xl font-bold micro-interaction hover:shadow-lg">Sign Up</button>
                <button type="button" id="cancel-signup" class="w-full glass py-3 rounded-xl font-medium hover:bg-purple-900/30 dark-text">Cancle</button>
            </form>
        </div>
    </div>

    <!-- Auth Required Modal -->
    <div id="auth-required-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="dark-modal rounded-3xl p-8 w-full max-w-md slide-in text-center">
            <div class="w-20 h-20 mx-auto bg-gradient-to-br from-purple-900 to-crimson-900 rounded-2xl flex items-center justify-center text-3xl mb-6">üîí</div>
            <h3 class="text-2xl font-bold mb-4 dark-text">Shrouded Path</h3>
            <p class="dark-text-secondary mb-8">Log Or Sign Up For Better Experiences</p>
            <div class="flex gap-4 mb-4">
                <button id="auth-login-btn" class="flex-1 btn-gradient py-3 rounded-xl font-semibold micro-interaction">Log In</button>
                <button id="auth-signup-btn" class="flex-1 crimson-gradient py-3 rounded-xl font-semibold micro-interaction">Sign Up</button>
            </div>
            <button id="auth-cancel" class="w-full glass py-2 rounded-xl dark-text-secondary hover:bg-purple-900/30">Remain Hidden</button>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed top-6 right-6 z-50 space-y-4"></div>

    <!-- Firebase SDKs (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
      /**************************************************************************
       *  üîß IMPORTANT: Replace firebaseConfig values with your Firebase project's
       *  credentials (from Firebase Console -> Project settings).
       *
       *  For development/testing you can leave these but on production be careful.
       **************************************************************************/


// Firebase compat SDK already loaded via script tags
  const firebaseConfig = {
    apiKey: "AIzaSyBA8Tis4gMJtK3-er7l9jvAv9fBzBeI5R4",
    authDomain: "storyverse-7704d.firebaseapp.com",
    projectId: "storyverse-7704d",
    storageBucket: "storyverse-7704d.appspot.com",
    messagingSenderId: "369929217040",
    appId: "1:369929217040:web:90086644f3135d0ca6d695",
    measurementId: "G-BWDBFVX8BF"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();



      // Toast helper
      const showToast = (message, type = 'info', duration = 4000) => {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
        const colors = { success: 'from-purple-700 to-purple-900', error: 'from-red-700 to-red-900', warning: 'from-amber-700 to-amber-900', info: 'from-indigo-700 to-indigo-900' };
        toast.className = `glass-strong rounded-2xl p-4 max-w-sm slide-in flex items-center gap-3`;
        toast.innerHTML = `
          <div class="w-10 h-10 rounded-full bg-gradient-to-r ${colors[type]} flex items-center justify-center text-lg">${icons[type]}</div>
          <div class="flex-1"><p class="font-medium dark-text">${message}</p></div>
          <button class="dark-text-secondary hover:text-white ml-2" onclick="this.parentElement.remove()">‚úï</button>
        `;
        container.appendChild(toast);
        setTimeout(() => {
          if (toast.parentElement) { toast.style.opacity = '0'; toast.style.transform = 'translateX(100%)'; setTimeout(() => toast.remove(), 300); }
        }, duration);
      };

      /*******************************
       * App state + DOM references
       *******************************/
      let currentUser = null;
      let storiesCache = []; // local view of stories
      let storyIdCounter = 1; // not used for DB ids but for local fallback if needed

      // DOM
      const avatar = document.getElementById('avatar');
      const userName = document.getElementById('user-name');
      const userStatus = document.getElementById('user-status');
      const loginBtn = document.getElementById('login-btn');
      const signupBtn = document.getElementById('signup-btn');
      const profileBtn = document.getElementById('profile-btn');
      const homeBtn = document.getElementById('home-btn');
      const logoutBtn = document.getElementById('logout-btn');
      const storyFormContainer = document.getElementById('story-form-container');
      const storyForm = document.getElementById('story-form');
      const storyText = document.getElementById('story-text');
      const charCount = document.getElementById('char-count');
      const storiesContainer = document.getElementById('stories-container');
      const storiesTitle = document.getElementById('stories-title');
      const storyCount = document.getElementById('story-count');

      // Modals
      const loginModal = document.getElementById('login-modal');
      const signupModal = document.getElementById('signup-modal');
      const authRequiredModal = document.getElementById('auth-required-modal');
      const loginForm = document.getElementById('login-form');
      const signupForm = document.getElementById('signup-form-modal');
      const cancelLogin = document.getElementById('cancel-login');
      const cancelSignup = document.getElementById('cancel-signup');
      const authLoginBtn = document.getElementById('auth-login-btn');
      const authSignupBtn = document.getElementById('auth-signup-btn');
      const authCancel = document.getElementById('auth-cancel');


/*******************************
 * Character counter (10,000 limit)
 *******************************/
storyText.addEventListener('input', () => {
  const count = storyText.value.length;
  charCount.textContent = `${count}/10000`;
  if (count > 10000) {
    charCount.classList.add('text-purple-400');
    storyText.value = storyText.value.substring(0, 10000);
  } else {
    charCount.classList.remove('text-purple-400');
  }
});


      /*******************************
       * UI update based on auth
       *******************************/
const updateUI = () => {
  if (currentUser) {
    avatar.textContent = (currentUser.name || currentUser.displayName || 'U').charAt(0).toUpperCase();
    userName.textContent = currentUser.name || currentUser.displayName || 'User';
    userStatus.textContent = 'Write & Explore Stories';
    userStatus.classList.add('text-purple-400');
    userStatus.classList.remove('dark-text-secondary');

    loginBtn.classList.add('hidden');
    signupBtn.classList.add('hidden');
    profileBtn.classList.remove('hidden');
    homeBtn.classList.remove('hidden');
    logoutBtn.classList.remove('hidden');
    storyFormContainer.classList.remove('hidden');

    // üëá Add this line
    currentPage = 'all-stories';
    displayStories();
    showToast("üåå Stories unlocked! Explore now.", "success");
  } else {
    avatar.textContent = '?';
    userName.textContent = 'Guest User';
    userStatus.textContent = 'Not Logged In';
    userStatus.classList.remove('text-purple-400');
    userStatus.classList.add('dark-text-secondary');

    loginBtn.classList.remove('hidden');
    signupBtn.classList.remove('hidden');
    profileBtn.classList.add('hidden');
    homeBtn.classList.add('hidden');
    logoutBtn.classList.add('hidden');
    storyFormContainer.classList.add('hidden');
  }
  displayStories(); // re-render with correct auth context
};


      /*******************************
       * Firestore: load stories (real-time)
       *******************************/
      let unsubscribeStories = null;
      function listenToStories() {
        if (unsubscribeStories) unsubscribeStories();
// listenToStories() ‚Äî replace problematic line with this:
// ‚úÖ Only fetch approved stories
unsubscribeStories = db.collection("stories")
  .where("approved", "==", true)
  .onSnapshot(snapshot => {
    storiesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    // manual sort by createdAt
    storiesCache.sort((a, b) => (b.createdAt?.toMillis?.() || 0) - (a.createdAt?.toMillis?.() || 0));

    displayStories();
  }, err => {
    console.error("Stories snapshot error:", err);
    showToast("Unable to load stories: " + err.message, "error");
  });



      }

      /*******************************
       * Display stories (UI)
       *******************************/
      const displayStories = () => {
        let displayedStories = storiesCache.slice();
        if (currentPage === 'my-stories' && currentUser) {
          displayedStories = displayedStories.filter(story => story.authorId === currentUser.id);
          storiesTitle.innerHTML = `<span class="text-3xl">üë§</span> My Stories`;
        } else {
          storiesTitle.innerHTML = `<span class="text-3xl">üìú</span> Stories`;
        }

        storyCount.textContent = `${displayedStories.length} stories`;
        storiesContainer.innerHTML = '';

        if (displayedStories.length === 0) {
          storiesContainer.innerHTML = `
            <div class="col-span-full text-center py-20">
              <div class="w-32 h-32 mx-auto bg-gradient-to-br from-purple-900/20 to-crimson-900/20 rounded-3xl flex items-center justify-center text-6xl mb-8">üìù</div>
              <h3 class="text-2xl font-bold mb-4 dark-text">The void awaits your story</h3>
              <p class="dark-text-secondary text-lg">Be the first to cast your shadow upon the page!</p>
            </div>
          `;
          return;
        }

        displayedStories.forEach((story, index) => {
          const isAuthor = currentUser && (story.authorId === currentUser.id);
          const hasLiked = currentUser && story.likes.includes(currentUser.id);

          const storyCard = document.createElement('div');
          storyCard.className = 'story-card glass-strong rounded-3xl p-8 slide-in';
          storyCard.style.animationDelay = `${index * 0.05}s`;

          // Truncate if needed
          const needsTruncation = typeof story.text === 'string' && story.text.length > 200;
          const truncatedText = needsTruncation ? story.text.substring(0, 200) + '...' : story.text;

          const commentsHtml = (story.comments || []).map(comment => `
            <div class="glass rounded-2xl p-4 border border-white/10">
              <div class="flex items-center gap-3 mb-3">
                <div class="w-8 h-8 rounded-full dark-avatar flex items-center justify-center text-sm font-bold">${(comment.authorName||'U').charAt(0)}</div>
                <div class="flex-1">
                  <div class="font-semibold dark-text">${comment.authorName}</div>
                  <div class="text-xs dark-text-secondary">${new Date(comment.createdAt).toLocaleDateString()}</div>
                </div>
              </div>
              <p class="dark-text leading-relaxed">${comment.text}</p>
            </div>
          `).join('');

          storyCard.innerHTML = `
            <div class="flex items-center gap-4 mb-6">
              <div class="w-14 h-14 rounded-2xl dark-avatar flex items-center justify-center text-xl font-bold">${(story.authorName||'U').charAt(0)}</div>
              <div class="flex-1">
                <div class="font-bold text-xl dark-text">${story.authorName}</div>
                <div class="text-sm dark-text-secondary">
  ${new Date(story.createdAt).toLocaleString()}
</div>

              </div>
              ${isAuthor ? `<button class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center hover:bg-red-900/30 transition-colors delete-story" data-id="${story.id}">üóëÔ∏è</button>` : ''}
            </div>
            <div class="mb-6">
              <div class="story-content ${needsTruncation ? 'truncated' : ''}" id="story-content-${story.id}">
                <p class="dark-text leading-relaxed whitespace-pre-line">${needsTruncation ? truncatedText : story.text}</p>
              </div>
              ${needsTruncation ? `<button class="read-more-btn mt-3 px-4 py-2 rounded-xl text-sm font-medium read-more" data-id="${story.id}" data-fulltext="${story.text.replace(/"/g, '&quot;')}">Read More</button>` : ''}
            </div>
            <div class="flex items-center justify-between mb-6">
              <div class="flex items-center gap-4">
                <button class="flex items-center gap-2 like-btn ${hasLiked ? 'text-purple-400' : 'dark-text-secondary'}" data-id="${story.id}">${hasLiked ? '‚ù§Ô∏è' : 'ü§ç'} <span class="text-sm">${(story.likes||[]).length}</span></button>
                <button class="flex items-center gap-2 comment-btn dark-text-secondary" data-id="${story.id}">üí¨ <span class="text-sm">${(story.comments||[]).length}</span></button>
              </div>
              <div class="text-xs dark-text-secondary">${Math.floor((Date.now() - story.createdAt) / 86400000)} Verified ‚úÖ </div>
            </div>
            <div class="comments-section hidden" id="comments-${story.id}">
              <div class="space-y-4 mb-4">${commentsHtml}</div>
              ${currentUser ? `
                <div class="flex gap-3">
                  <input type="text" class="flex-1 dark-input rounded-xl p-3 placeholder-gray-500 focus:outline-none comment-input" placeholder="Whisper a comment..." id="comment-input-${story.id}">
                  <button class="btn-gradient px-4 rounded-xl font-semibold add-comment" data-id="${story.id}">Echo</button>
                </div>
              ` : `<button class="w-full glass py-3 rounded-xl text-center auth-required-comment dark-text" data-id="${story.id}">Reveal yourself to comment</button>`}
            </div>
          `;
          storiesContainer.appendChild(storyCard);
        });

        attachEventListeners();
      };

      /*******************************
       * Attach event listeners (buttons inside stories)
       *******************************/
      const attachEventListeners = () => {
        // Likes
        document.querySelectorAll('.like-btn').forEach(btn => {
          btn.removeEventListener('click', likeClickHandler);
          btn.addEventListener('click', likeClickHandler);
        });

        // Comment toggle
        document.querySelectorAll('.comment-btn').forEach(btn => {
          btn.removeEventListener('click', commentToggleHandler);
          btn.addEventListener('click', commentToggleHandler);
        });

        // Add comment
        document.querySelectorAll('.add-comment').forEach(btn => {
          btn.removeEventListener('click', addCommentHandler);
          btn.addEventListener('click', addCommentHandler);
        });

        // Auth-required comment
        document.querySelectorAll('.auth-required-comment').forEach(btn => {
          btn.removeEventListener('click', showAuthRequiredModal);
          btn.addEventListener('click', showAuthRequiredModal);
        });

        // Delete story
        document.querySelectorAll('.delete-story').forEach(btn => {
          btn.removeEventListener('click', deleteStoryHandler);
          btn.addEventListener('click', deleteStoryHandler);
        });

        // Read more / read less
        document.querySelectorAll('.read-more').forEach(btn => {
          btn.removeEventListener('click', readMoreHandler);
          btn.addEventListener('click', readMoreHandler);
        });
      };

      // handlers (separate named functions so removeEventListener works)
      function likeClickHandler(e) {
        const storyId = e.currentTarget.getAttribute('data-id');
        if (!currentUser) { showAuthRequiredModal(); return; }
        toggleLike(storyId);
      }
      
      const editProfileBtn = document.getElementById('edit-profile-btn');
const editProfileModal = document.getElementById('edit-profile-modal');
const editProfileForm = document.getElementById('edit-profile-form');
const cancelEdit = document.getElementById('cancel-edit');

// Show button only if logged in
if (currentUser) editProfileBtn.classList.remove('hidden');

// Show modal
editProfileBtn.addEventListener('click', () => showModal(editProfileModal));
cancelEdit.addEventListener('click', () => hideModal(editProfileModal));

// Save new name
editProfileForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const newName = document.getElementById('edit-name').value.trim();
  if (!newName) return showToast("Name cannot be empty", "warning");
  try {
    // update Firestore
    await db.collection('users').doc(currentUser.id).update({ name: newName });
    // update local user object
    currentUser.name = newName;
    // update Firebase profile
    const user = auth.currentUser;
    if (user) await user.updateProfile({ displayName: newName });
    hideModal(editProfileModal);
    updateUI();
    showToast("‚úÖ Profile name updated!", "success");
  } catch (err) {
    console.error(err);
    showToast("Error updating name: " + err.message, "error");
  }
});


      function commentToggleHandler(e) {
        const storyId = e.currentTarget.getAttribute('data-id');
        const commentsSection = document.getElementById(`comments-${storyId}`);
        if (commentsSection) commentsSection.classList.toggle('hidden');
      }

      async function addCommentHandler(e) {
        const storyId = e.currentTarget.getAttribute('data-id');
        const commentInput = document.getElementById(`comment-input-${storyId}`);
        const commentText = commentInput.value.trim();
        if (!commentText) return;
        await postComment(storyId, commentText);
        commentInput.value = '';
      }

      function deleteStoryHandler(e) {
        const storyId = e.currentTarget.getAttribute('data-id');
        deleteStory(storyId);
      }

      function readMoreHandler(e) {
        const storyId = e.currentTarget.getAttribute('data-id');
        const fullText = e.currentTarget.getAttribute('data-fulltext');
        const contentElement = document.getElementById(`story-content-${storyId}`);
        if (e.currentTarget.textContent === 'Read More') {
          contentElement.innerHTML = `<p class="dark-text leading-relaxed whitespace-pre-line">${fullText}</p>`;
          contentElement.classList.remove('truncated');
          e.currentTarget.textContent = 'Read Less';
        } else {
          const truncatedText = fullText.substring(0, 200) + '...';
          contentElement.innerHTML = `<p class="dark-text leading-relaxed whitespace-pre-line">${truncatedText}</p>`;
          contentElement.classList.add('truncated');
          e.currentTarget.textContent = 'Read More';
        }
      }

      /*******************************
       * Like toggling (transaction)
       *******************************/
      async function toggleLike(storyId) {
        const storyRef = db.collection('stories').doc(storyId);
        try {
          await db.runTransaction(async (tx) => {
            const doc = await tx.get(storyRef);
            if (!doc.exists) throw "Story not found";
            const data = doc.data();
            const likes = data.likes || [];
            const index = likes.indexOf(currentUser.id);
            if (index === -1) {
              likes.push(currentUser.id);
            } else {
              likes.splice(index, 1);
            }
            tx.update(storyRef, { likes });
          });
          showToast('Like toggled', 'success');
        } catch (err) {
          console.error('toggleLike error', err);
          showToast('Unable to toggle like: ' + err.message, 'error');
        }
      }

      /*******************************
       * Post comment
       *******************************/
      async function postComment(storyId, text) {
        const storyRef = db.collection('stories').doc(storyId);
        const comment = { text, authorId: currentUser.id, authorName: currentUser.name, createdAt: Date.now() };
        try {
          await db.runTransaction(async tx => {
            const doc = await tx.get(storyRef);
            if (!doc.exists) throw "Story not found";
            const data = doc.data();
            const comments = data.comments || [];
            comments.push(comment);
            tx.update(storyRef, { comments });
          });
          showToast('Whisper added to the void!', 'success');
        } catch (err) {
          console.error('postComment error', err);
          showToast('Unable to add comment: ' + err.message, 'error');
        }
      }

      /*******************************
       * Delete story (author only)
       *******************************/
      async function deleteStory(storyId) {
        if (!confirm('Are you certain you wish to banish this story to the void? This cannot be undone.')) return;
        const storyRef = db.collection('stories').doc(storyId);
        try {
          const doc = await storyRef.get();
          if (!doc.exists) return showToast('Story not found', 'error');
          const data = doc.data();
          if (!currentUser || data.authorId !== currentUser.id) {
            return showToast('You are not allowed to delete this story', 'error');
          }
          await storyRef.delete();
          showToast('Story Deleted', 'info');
        } catch (err) {
          console.error('deleteStory error', err);
          showToast('Unable to delete story: ' + err.message, 'error');
        }
      }

      /*******************************
       * Sign up, Login, Logout integration
       *******************************/
      const showModal = (modal) => { modal.classList.remove('hidden'); document.body.style.overflow = 'hidden'; };
      const hideModal = (modal) => { modal.classList.add('hidden'); document.body.style.overflow = 'auto'; };
      const showAuthRequiredModal = () => showModal(authRequiredModal);

      // Signup flow (modal)
      signupForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('signup-name').value.trim();
        const email = document.getElementById('signup-email').value.trim();
        const password = document.getElementById('signup-password').value.trim();
        if (!name || !email || !password) return showToast('Fill all fields', 'warning');
        try {
          const userCredential = await auth.createUserWithEmailAndPassword(email, password);
          const user = userCredential.user;
          // Save user info to Firestore under users/{uid}
          await db.collection('users').doc(user.uid).set({
            name,
            email,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          // set display name in firebase auth profile (optional)
          await user.updateProfile({ displayName: name });
          currentUser = { id: user.uid, name, email };
          hideModal(signupModal);
          updateUI();
          showToast(`Welcome to the night, ${name}! Your shadow now walks among us.`, 'success');
        } catch (err) {
          console.error('signup error', err);
          showToast(err.message, 'error');
        }
      });

      // Login flow (modal)
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value.trim();
        if (!email || !password) return showToast('Fill both email and password', 'warning');
        try {
          const userCredential = await auth.signInWithEmailAndPassword(email, password);
          const user = userCredential.user;
          // fetch user profile from Firestore
          const doc = await db.collection('users').doc(user.uid).get();
          if (doc.exists) {
            currentUser = { id: user.uid, ...doc.data() };
          } else {
            currentUser = { id: user.uid, name: user.displayName || 'User', email: user.email };
          }
          hideModal(loginModal);
          updateUI();
          showToast(`Welcome back, ${currentUser.name}! The night has missed you.`, 'success');
        } catch (err) {
          console.error('login error', err);
          showToast(err.message, 'error');
        }
      });

      // Button click handlers to show modals
      loginBtn.addEventListener('click', () => showModal(loginModal));
      signupBtn.addEventListener('click', () => showModal(signupModal));
      profileBtn.addEventListener('click', () => { currentPage = 'my-stories'; displayStories(); });
      homeBtn.addEventListener('click', () => { currentPage = 'all-stories'; displayStories(); });
      logoutBtn.addEventListener('click', async () => {
        await auth.signOut();
        currentUser = null;
        updateUI();
        showToast('You have retreated to the shadows', 'info');
      });

      cancelLogin.addEventListener('click', () => hideModal(loginModal));
      cancelSignup.addEventListener('click', () => hideModal(signupModal));
      authLoginBtn.addEventListener('click', () => { hideModal(authRequiredModal); showModal(loginModal); });
      authSignupBtn.addEventListener('click', () => { hideModal(authRequiredModal); showModal(signupModal); });
      authCancel.addEventListener('click', () => hideModal(authRequiredModal));

      // Close modals when clicking outside
      document.addEventListener('click', (e) => {
        if (e.target === loginModal) hideModal(loginModal);
        if (e.target === signupModal) hideModal(signupModal);
        if (e.target === authRequiredModal) hideModal(authRequiredModal);
      });

      // Story form submission -> save to Firestore
      storyForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = storyText.value.trim();
        if (!text) { showToast('The void demands words before it will listen', 'warning'); return; }
        if (!currentUser) { showAuthRequiredModal(); return; }
        try {
await db.collection('stories').add({
    text,
    authorId: currentUser.id,
    authorName: currentUser.name,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    likes: [],
    comments: [],
    approved: false   //  mehema denna one
});

          storyText.value = '';
          charCount.textContent = '0/10000';
          showToast('Your Story Has Been Uploaded This Page!', 'success');
          // Firestore real-time listener will update UI automatically
        } catch (err) {
          console.error('post story error', err);
          showToast('Unable to post story: ' + err.message, 'error');
        }
      });

      // Auth state listener: keep currentUser synced if user is already logged in
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          // fetch user profile from Firestore
          try {
            const doc = await db.collection('users').doc(user.uid).get();
            if (doc.exists) {
              currentUser = { id: user.uid, ...doc.data() };
            } else {
              currentUser = { id: user.uid, name: user.displayName || user.email.split('@')[0], email: user.email };
            }
          } catch (err) {
            currentUser = { id: user.uid, name: user.displayName || user.email.split('@')[0], email: user.email };
          }
        } else {
          currentUser = null;
        }
        updateUI();
      });

      
      

      // Start listening to stories in real-time
      listenToStories();

      // Show toast when site loads if not logged in
     window.addEventListener("load", () => {
      if (!currentUser) {
     showToast("üîí Please log in to see stories", "warning", 6000);
      }
    });


      // Keyboard enter comment support (optional)
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.target && e.target.classList.contains('comment-input')) {
          const storyId = e.target.id.replace('comment-input-', '');
          const commentText = e.target.value.trim();
          if (commentText && currentUser) {
            postComment(storyId, commentText);
            e.target.value = '';
          }
        }
      });

      // Small animation setup (original)
      setTimeout(() => {
        document.querySelectorAll('.story-card').forEach((card, index) => {
          card.style.animationDelay = `${index * 0.1}s`;
        });
      }, 100);
    </script>

    <!-- (Optional: include your original long <style> block here exactly as in your original file) -->
    <style>
    /* Full original styles (exact copy from your uploaded index.html).
       I truncated earlier for message brevity, but keep them here in the actual file. */

    * {
        font-family: 'Space Grotesk', sans-serif;
    }
    body {
        background: #050508;
        overflow-x: hidden;
        color: #e0e0e0;
  padding-bottom: 80px; /* footer height + little gap */
    }

    .bg-mesh {
        background: 
            radial-gradient(at 40% 20%, hsla(265, 70%, 25%, 0.7) 0px, transparent 50%),
            radial-gradient(at 80% 0%, hsla(240, 60%, 15%, 0.7) 0px, transparent 50%),
            radial-gradient(at 0% 50%, hsla(300, 50%, 20%, 0.5) 0px, transparent 50%),
            radial-gradient(at 80% 50%, hsla(280, 60%, 15%, 0.6) 0px, transparent 50%),
            radial-gradient(at 0% 100%, hsla(340, 60%, 15%, 0.6) 0px, transparent 50%),
            radial-gradient(at 80% 100%, hsla(260, 70%, 20%, 0.7) 0px, transparent 50%),
            radial-gradient(at 0% 0%, hsla(300, 70%, 15%, 0.7) 0px, transparent 50%);
    }

    .glass {
        background: rgba(10, 5, 20, 0.7);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(100, 70, 150, 0.2);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .glass-strong {
        background: rgba(15, 8, 25, 0.8);
        backdrop-filter: blur(30px);
        border: 1px solid rgba(120, 80, 180, 0.3);
        box-shadow: 0 6px 25px rgba(0, 0, 0, 0.4);
    }

    .glow {
        box-shadow: 0 0 30px rgba(100, 60, 180, 0.4);
    }

    .glow-hover:hover {
        box-shadow: 0 0 40px rgba(120, 70, 200, 0.6);
        transform: translateY(-2px);
    }

    .floating {
        animation: float 6s ease-in-out infinite;
    }

    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-20px) rotate(2deg); }
    }

    .slide-in {
        animation: slideIn 0.8s cubic-bezier(0.23, 1, 0.320, 1);
    }

    @keyframes slideIn {
        from { opacity: 0; transform: translateY(60px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .pulse-border {
        border: 2px solid transparent;
        background: linear-gradient(45deg, #5a2d9c, #3b1b6d) border-box;
        mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
        mask-composite: exclude;
    }

    .story-card {
        transition: all 0.4s cubic-bezier(0.23, 1, 0.320, 1);
        background: linear-gradient(145deg, #0f0823, #1a1035);
        border: 1px solid rgba(90, 60, 140, 0.3);
    }

    .story-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 15px 30px rgba(40, 10, 80, 0.4);
    }

    .neon-text {
        text-shadow: 0 0 10px rgba(140, 70, 220, 0.7),
                     0 0 20px rgba(120, 50, 200, 0.5),
                     0 0 30px rgba(100, 40, 180, 0.3);
        color: #d8c7ff;
    }

    .btn-gradient {
        background: linear-gradient(135deg, #5a2d9c 0%, #3b1b6d 100%);
        transition: all 0.3s ease;
        color: #e0d5ff;
    }

    .btn-gradient:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(90, 45, 156, 0.5);
        background: linear-gradient(135deg, #643ca9 0%, #4a2488 100%);
    }

    .hidden { display: none !important; }

    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }

    .typing-animation::after {
        content: '|';
        animation: blink 1s infinite;
    }

    @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0; }
    }

    .micro-interaction {
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .micro-interaction:active {
        transform: scale(0.95);
    }

    .noise {
        background-image: 
            radial-gradient(circle at 25px 25px, rgba(60, 30, 100, 0.2) 2%, transparent 0%),
            radial-gradient(circle at 75px 75px, rgba(70, 35, 110, 0.1) 2%, transparent 0%);
        background-size: 100px 100px;
    }

    /* New styles for truncated text and read more */
    .story-content {
        position: relative;
        overflow: hidden;
        transition: max-height 0.5s ease;
    }

    .story-content.truncated {
        max-height: 150px;
        mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
        -webkit-mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
    }

    .read-more-btn {
        background: rgba(90, 45, 156, 0.3);
        border: 1px solid rgba(110, 65, 176, 0.4);
        color: #c9b2ff;
        transition: all 0.3s ease;
    }

    .read-more-btn:hover {
        background: rgba(110, 65, 176, 0.4);
        transform: translateY(-2px);
    }

    /* Dark theme specific styles */
    .dark-input {
        background: rgba(20, 10, 35, 0.7);
        border: 1px solid rgba(100, 70, 150, 0.4);
        color: #e0d5ff;
    }

    .dark-input:focus {
        outline: none;
        border-color: #7a4fcc;
        box-shadow: 0 0 0 2px rgba(122, 79, 204, 0.3);
    }

    .dark-input::placeholder {
        color: #8870a5;
    }

    .crimson-gradient {
        background: linear-gradient(135deg, #8c1a4c 0%, #5a1035 100%);
    }

    .crimson-gradient:hover {
        background: linear-gradient(135deg, #9e2a5c 0%, #6c2045 100%);
    }

    .dark-modal {
        background: rgba(10, 5, 20, 0.95);
        border: 1px solid rgba(120, 80, 180, 0.4);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
    }

    .dark-text {
        color: #d0c5ef;
    }

    .dark-text-secondary {
        color: #a090c0;
    }

    .dark-divider {
        border-color: rgba(90, 70, 130, 0.3);
    }

    .dark-avatar {
        background: linear-gradient(135deg, #5a2d9c, #8c1a4c);
    }
    </style>
</body>
</html>
